<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <title>ê²°ì œ í˜ì´ì§€</title>
</head>
<th:block layout:fragment="script">
<script th:inline="javascript">

    function processPayment() {
      var token = $("meta[name='_csrf']").attr("content");
      var header = $("meta[name='_csrf_header']").attr("content");

      var productName = $("#productName").val();
      var count = parseInt($("#count").val(), 10) || 1;
      var price = parseInt($("#price").val(), 10) || 0;
      var totalPrice = price * count;

      // âœ… ë””ë²„ê¹… ë¡œê·¸
      console.log("ğŸ“Œ ìƒí’ˆëª…:", productName);
      console.log("ğŸ“Œ êµ¬ë§¤ ìˆ˜ëŸ‰:", count);
      console.log("ğŸ“Œ ì´ ê²°ì œ ê¸ˆì•¡:", totalPrice);

      // âœ… ìœ íš¨ì„± ê²€ì‚¬
      if (!productName || productName.trim() === "") {
          alert("ìƒí’ˆëª…ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
      }
      if (isNaN(count) || count <= 0) {
          alert("ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
      }
      if (isNaN(totalPrice) || totalPrice <= 0) {
          alert("ì´ ê²°ì œ ê¸ˆì•¡ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
      }

      var IMP = window.IMP;
      IMP.init('imp42785767'); // âœ… ì•„ì„í¬íŠ¸ ê°€ë§¹ì  ì½”ë“œ

      IMP.request_pay({
          pg: "kakaopay.TC0ONETIME",
          merchant_uid: 'order_' + new Date().getTime(), // âœ… ì£¼ë¬¸ ê³ ìœ ë²ˆí˜¸ ìƒì„±
          name: productName,
          amount: totalPrice,
          buyer_email: 'test@example.com',  // âœ… ì˜ˆì œìš© ì´ë©”ì¼
          buyer_name: 'êµ¬ë§¤ì ì´ë¦„',       // âœ… êµ¬ë§¤ì ì´ë¦„
          buyer_tel: '010-1234-5678'       // âœ… êµ¬ë§¤ì ì „í™”ë²ˆí˜¸
      }, function (rsp) {
          if (rsp.success) {
              var orderData = {
                  impUid: rsp.imp_uid,        // âœ… ê²°ì œ ê³ ìœ ë²ˆí˜¸
                  merchantUid: rsp.merchant_uid, // âœ… ê°€ë§¹ì  ì£¼ë¬¸ë²ˆí˜¸
                  productName: productName, // âœ… ìƒí’ˆëª…
                  quantity: count,         // âœ… êµ¬ë§¤ ìˆ˜ëŸ‰
                  totalPrice: totalPrice   // âœ… ì´ ê²°ì œ ê¸ˆì•¡
              };

              console.log("ğŸ“Œ ì„œë²„ë¡œ ë³´ë‚¼ ì£¼ë¬¸ ë°ì´í„°:", orderData);

              $.ajax({
                  url: "/buy",
                  type: "POST",
                  contentType: "application/json",
                  data: JSON.stringify(orderData),
                  beforeSend: function (xhr) {
                      xhr.setRequestHeader(header, token);
                  },
                  success: function (response) {
                      alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì£¼ë¬¸ ë²ˆí˜¸: " + response);
                      location.href = '/';
                  },
                  error: function (jqXHR) {
                      alert("ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + jqXHR.responseText);
                  }
              });
          } else {
              alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
          }
      });
  }



</script>
</th:block>

<div layout:fragment="content">
<h2>ê²°ì œ í˜ì´ì§€</h2>

<p>ìƒí’ˆëª…: <span th:text="${productName}"></span></p> <!-- âœ… ìƒí’ˆëª… ì¶”ê°€ -->
<p>ìƒí’ˆ ID: <span th:text="${productId}"></span></p>
<p>êµ¬ë§¤ ìˆ˜ëŸ‰: <span th:text="${count}"></span> ê°œ</p>
<p>ì´ ê²°ì œ ê¸ˆì•¡: <span th:text="${totalPrice}"></span> ì›</p>

<!-- ì‹¤ì œ ê²°ì œ ì²˜ë¦¬ ë²„íŠ¼ -->
<button onclick="processPayment()">ê²°ì œí•˜ê¸°</button>
    <!-- âœ… product ê°ì²´ê°€ ì „ë‹¬ë˜ëŠ”ì§€ í™•ì¸ -->
    <p th:if="${product != null}">ìƒí’ˆ ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.</p>
    <p th:unless="${product != null}">âŒ ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!</p>

    <!-- âœ… ê°œë³„ í•„ë“œ ê°’ í™•ì¸ -->

    <!-- ğŸ” ë””ë²„ê¹…ìš© (ê°’ì´ ì•ˆ ë‚˜ì˜¤ëŠ” ê²½ìš° 'ê°’ ì—†ìŒ' í‘œì‹œ) -->
    <p>ğŸ” `productId`: <span th:text="${productId != null ? productId : 'ê°’ ì—†ìŒ'}"></span></p>
    <p>ğŸ” `productName`: <span th:text="${productName != null ? productName : 'ê°’ ì—†ìŒ'}"></span></p>
    <p>ğŸ” `count`: <span th:text="${count != null ? count : 'ê°’ ì—†ìŒ'}"></span></p>
    <p>ğŸ” `totalPrice`: <span th:text="${totalPrice != null ? totalPrice : 'ê°’ ì—†ìŒ'}"></span></p>


</div>

</html>
